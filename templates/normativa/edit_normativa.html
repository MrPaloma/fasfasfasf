{% extends 'base_nfr.html' %}
{% load static %}

{% block content %}
    
    <div class="container ">
        <div class="row text-center">
            <div class="col-2">
                <a href="{% url 'home' %}">
                    <i class="fa fa-home fa-3x text-warning" aria-hidden="true"></i>
                </a>
            </div>
    
            <div class="col-8">
                <h1 class="gUppercase gFontWeight700">
                    Editar Normativa
                </h1>
            </div>
    
            <div class="col-2">
                <a href="{% url 'index-normativas' %}">
                    <i class="fa fa-arrow-right fa-3x text-warning" aria-hidden="true"></i>
                </a>
            </div>
            <div class="col-1"></div>
        </div>
        <br><br>
        <form  id="fileForm" method='POST' enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-6">
                    <label for="norma">Norma</label>
                    <input type="text" class="form-control" id="id_norma" name="norma" value="{{normativa.norma}}" required/>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label for="name_deno">Titulo</label>
                        <input type="text" name="name_denom" id="id_name_denom" class="form-control" value="{{normativa.name_denom}}" required/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <label for="base">Base Legal</label>
                    <input type="text" name="base_legal" id="id_base_legal" class="form-control" value="{{normativa.base_legal}}" required/>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label for="fecha_publi">Publicacion</label>
                        <input id="id_fecha_publi" type="date" name="fecha_publi" class="form-control" value="{{normativa.fecha_publi|date:"Y-m-d"}}" required min="1900-01-01" max="{{fecha_hoy}}"/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <label> Tipo de Norma: </label>
                    <select class="form-control" aria-label="Default select example" name="tipo_norma" id="id_tipo_norma">
                                            {% for tipo_norma in tipo_normativa %}
                                                <option value="{{tipo_norma.id}}">{{tipo_norma.subcategory_name}}</option>
                                            {% endfor %}
                                    </select>
                </div>
                <div class="col-6">
                    <label> Tipo de Uso: </label>
                    <select class="form-control" aria-label="Default select example" name="tipo_uso" id="id_tipo_uso">
                                    {% for tipo_uso in tipo_uso %}
                                        <option value="{{tipo_uso.id}}">{{tipo_uso.area_name}}</option>
                                    {% endfor %}
                                </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-6">
                    <div class="form-group">
                        <label>Adjuntar Documento</label>
                        <br>
                        {% if normativa.document %}
                            <a class="text-dark" target="_blank" href="{{normativa.document.url}}">
                                <b> Esta Normativa tiene archivo (click para ver) </b>
                            </a>
                        {% endif %}
                        <input id="id_document" type="file" name="document"/>
                    </div>
                    <div class="mt-3">
                        <div class="shadow w-full bg-gray-100">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                              </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <h3 id="status"></h3>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="id_es_vigente" name="es_vigente">
                            <label class="custom-control-label" for="id_es_vigente">Vigente</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="id_es_foro" name="es_foro">
                            <label class="custom-control-label" for="id_es_foro">Foro</label>
                        </div>
                    </div>
                    
                    
                </div>
                <div class="col-6">
                    <label>Descripci√≥n breve</label><br>
                    <textarea class="form-control" rows="5" maxlength="200" name="descripcion" id="id_descripcion">{% if normativa.descripcion %} {{normativa.descripcion}} {% endif %}</textarea>
                </div>
            </div>
            <button class="btn btn-lg btn-primary float-right" type="submit" id="submitBtn" >Guardar Cambios</button>
        </form>
        <h2 class="text-center mt-5"> Editar Palabras Clave</h2>
        {% include '../partials/_palabras_clave.html' %}
        
    </div>
{% endblock %}


{% block js %}
<script>
    
</script>

    <script>

        

        $(document).ready(function() {

            $('#id_tipo_norma').val('{{normativa.tipo_norma_id}}')    
            $('#id_tipo_uso').val('{{normativa.tipo_uso_id}}')    
            $('#id_es_foro').prop('checked',  '{{normativa.es_foro}}' == 'True' ? true : false )
            $('#id_es_vigente').prop('checked',  '{{normativa.es_vigente}}' == 'True' ? true : false )
            
            $("#registrar_palabras").submit( function(e) {
                e.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: $(this).serialize()
                  }).done(function(data) {
                    $('.select-tags').val(null).trigger('change');
                    html = ``
    
                    data.forEach((e) => {
                        html += /*html*/
                                `<tr>
                                    <th scope="row">${e.id}</th>
                                    <td>${e.name}</td>
                                    <td>
                                        <button type="button" onclick="eliminarPc(${e.id})" class="btn btn-block btn-danger">    
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`
                    })
    
                    document.getElementById('normativas_palabras_clave').innerHTML = html;
    
                  });
            })
    
            
            
    
        });
    
        function eliminarPc(id) {
            $.ajax({
                url: `{% url 'eliminar-palabras-clave-normativa' normativa.id %}`,
                data: {
                    'palabra_clave_id' : id
                }
                }).done(function(data) {
    
                html = ``
    
                data.forEach((e) => {
                    html += /*html*/
                            `<tr>
                                <th scope="row">${e.id}</th>
                                <td>${e.name}</td>
                                <td>
                                    <button type="button" onclick="eliminarPc(${e.id})" class="btn btn-block btn-danger">    
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>`
                })
    
                document.getElementById('normativas_palabras_clave').innerHTML = html;
    
                });
        }

        let submitting = false
        let file = null

        function setIsSubmitting(val) {
            submitting = val
        }

        function setFile(val) {
            file = val
        }

        _("id_document").addEventListener("change", event => {
            setFile(event.target.files[0])
        })

        _("submitBtn").addEventListener("click", event => {
            if (file != null && _('id_fecha') != undefined) {
                handleSubmit(event)
                _("submitBtn").disabled = true
                _("submitBtn").innerHTML = /*html*/`<div class="spinner-border spinner-border-sm text-light" role="status">
                                                        <span class="sr-only">Loading...</span>                   
                                                        </div>
                                                    Guardar
                                                    `
            }
        })

        const handleSubmit = async event => {

            setIsSubmitting(true)

            const signedUrl = await getSignedUrl()

            try {
                uploadFile(signedUrl)
            }
            catch (err) {
                setIsSubmitting(false)
                console.log(err)
                alert('There was an error uploading your file.')
                throw err
            }

            setIsSubmitting(false)
        }

        const getSignedUrl = async () => {
            const body = {
                fileName: file.name,
                fileType: file.type,
            }

            const response = await fetch("{% url 'signed-url' %}", {
                method: 'POST',
                body: JSON.stringify(body),
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}"}
            })
            const { url } = await response.json()
            return url
        }

        function _(el) {
            return document.getElementById(el);
        }

        function uploadFile(signedUrl) {
            var formdata = new FormData();
            formdata.append("file", file);
            var ajax = new XMLHttpRequest();
            ajax.upload.addEventListener("progress", progressHandler, false);
            ajax.addEventListener("load", completeHandler, false);
            ajax.addEventListener("error", errorHandler, false);
            ajax.addEventListener("abort", abortHandler, false);
            ajax.addEventListener("loadend", loadendHandler, false)
            ajax.open("PUT", signedUrl);
            ajax.setRequestHeader('Content-Type', file.type)
            ajax.setRequestHeader('x-amz-acl', 'public-read')
            ajax.send(formdata);
        }

        async function submitForm() {
            _("fileForm").submit()
            _("submitBtn").disabled = false
        }

        async function loadendHandler(event) {
            await submitForm()
        }

        function progressHandler(event) {
            var percent = Math.round((event.loaded / event.total) * 100);
            _("progressBar").style.width = `${percent}%`;
            _("progressBar").innerText = `${percent}%`;
            _("status").innerHTML = percent + "% Subiendo.. espere un momento";
        }

        function completeHandler(event) {
            _("status").innerHTML = event.target.responseText;
            _("progressBar").style.width = 0;
            _("progressBar").innerText = "0%";
        }

        function errorHandler(event) {
            _("status").innerHTML = "Por favor espere";
        }

        function abortHandler(event) {
            _("status").innerHTML = "Upload Aborted";
        }


    </script>
{% endblock %}